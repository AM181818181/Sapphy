<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Small Black Dog: Find My Sister</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    background: black;
    overflow: hidden;
  }
  canvas {
    display: block;
    margin: 0 auto;
    background: #000;
  }
  #bubble, #tooltip, #endText {
    position: absolute;
    font-family: sans-serif;
    font-size: 24px;
    color: white;
    text-shadow: 2px 2px 2px black;
    padding: 8px 12px;
    border-radius: 8px;
    max-width: 50%;
    text-align: center;
    pointer-events: none;
  }
  #bubble {
    background: rgba(0,0,0,0.5);
    top: 10%;
    left: 50%;
    transform: translateX(-50%);
  }
  #tooltip {
    background: rgba(0,0,0,0.7);
    bottom: 5%;
    left: 50%;
    transform: translateX(-50%);
  }
  #endText {
    background: transparent;
    font-size: 48px;
    top: 50%;
    left: 50%;
    transform: translate(-50%,-50%);
    opacity: 0;
    transition: opacity 2s;
  }
</style>
</head>
<body>
<canvas id="game" width="1920" height="1080"></canvas>
<div id="bubble"></div>
<div id="tooltip"></div>
<div id="endText">No more howling for Sapphy</div>
<script>
/* ---------------------
   GAME SETUP
--------------------- */
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const bubbleEl = document.getElementById('bubble');
const tooltipEl = document.getElementById('tooltip');
const endTextEl = document.getElementById('endText');

function showBubble(text, duration=2000) {
  bubbleEl.textContent = text;
  bubbleEl.style.display = 'block';
  if (duration) {
    setTimeout(()=>bubbleEl.style.display = 'none', duration);
  }
}
function showTooltip(text, duration=2000) {
  tooltipEl.textContent = text;
  tooltipEl.style.display = 'block';
  if (duration) {
    setTimeout(()=>tooltipEl.style.display = 'none', duration);
  }
}

/* ---------------------
   ASSETS
--------------------- */
const imgNames = [
  "splashscreen.png","lvl1.png","lvl1dooropen.png","lvl2.png","finalscreen.png",
  "sit.png","walk1.png","walk2.png","walk3.png","sniff1.png","howl.png",
  "treat1.png","treat2.png","introvideo.mp4"
];
const images = {};
function loadImages(names, cb) {
  let loaded = 0;
  names.forEach(n=>{
    const img = new Image();
    img.src = n;
    img.onload = ()=>{ if (++loaded === names.length) cb(); }
    images[n] = img;
  });
}

const audioNames = {
  bgm: "BGMUSIC.mp3",
  final: "final music.mp3",
  sniff1: "Sniff1.m4a",
  sniff2: "sniff2.m4a",
  bark: "bark1.m4a",
  howl1: "howl1.m4a",
  howl2: "howl2.m4a",
  pickup: "treatpickup.m4a",
  dooropen: "dooropen.wav",
  knock: "door knock.wav",
  letout: "letoutvoice.m4a",
  rain: "rain.wav"
};
const sounds = {};
for (let k in audioNames) {
  sounds[k] = new Audio(audioNames[k]);
}

/* ---------------------
   GAME STATE
--------------------- */
let scene = "splash";
let bg = images["splashscreen.png"];
let dogX = 200, dogY = 700;
let dogState = "sit";
let walkFrame = 0, sniffFrame = 0, barkTimer = 0;
let treatsCollected = 0;
let sniffCount = 0;
let actionCount = 0;
let bgmPlaying = false;
let rainPlaying = false;
let startFinalTime = 0;

/* ---------------------
   AUDIO CONTROL
--------------------- */
function playBGM() {
  if (!bgmPlaying) {
    sounds.bgm.loop = true;
    sounds.bgm.volume = 0.7;
    sounds.bgm.play();
    bgmPlaying = true;
  }
}
function stopBGM() {
  sounds.bgm.pause();
  sounds.bgm.currentTime = 0;
  bgmPlaying = false;
}
function duckBGM(amount, dur) {
  const original = 0.7;
  sounds.bgm.volume = original + amount;
  setTimeout(()=>sounds.bgm.volume = original, dur);
}

/* ---------------------
   INPUT
--------------------- */
const keys = {};
window.addEventListener('keydown', e=>{ keys[e.key.toLowerCase()] = true; });
window.addEventListener('keyup', e=>{ keys[e.key.toLowerCase()] = false; });

/* ---------------------
   SCENE HANDLERS
--------------------- */
function startLevel1() {
  scene = "level1";
  bg = images["lvl1.png"];
  dogX = 200;
  treatsCollected = 0;
  sniffCount = 0;
  showBubble("I can smell something good!",2000);
  showTooltip("Press S to sniff",2000);
}

function handleLevel1() {
  if (keys['s']) {
    dogState = "sniff";
    if (!sounds.sniff1.paused || !sounds.sniff2.paused) {} else {
      const snd = (Math.random()<0.5)? sounds.sniff1 : sounds.sniff2;
      duckBGM(-0.4, 500);
      snd.play();
      sniffCount++;
      if (sniffCount >= 3) {
        // spawn treat
        sniffCount = 0;
        treatsCollected++;
        showBubble("I'll keep that for later",2000);
        duckBGM(-0.4, 500);
        sounds.pickup.play();
        if (treatsCollected>=3) {
          showTooltip("Press H to howl",3000);
        }
      }
    }
  }
  if (treatsCollected>=3 && keys['h']) {
    dogState = "howl";
    const howlSnd = (Math.random()<0.5)? sounds.howl1 : sounds.howl2;
    duckBGM(-0.8, howlSnd.duration*1000);
    howlSnd.play();
    setTimeout(()=>{
      duckBGM(-0.8, 1500);
      sounds.letout.play();
      setTimeout(()=>{
        duckBGM(-0.6, 1500);
        sounds.dooropen.play();
        bg = images["lvl1dooropen.png"];
        setTimeout(()=>{
          sounds.rain.loop = true;
          sounds.rain.volume = 0.8;
          sounds.rain.play();
          showBubble("It's raining out there... I'm not going out there",2000);
          setTimeout(()=>startLevel2(),2000);
        },500);
      },400);
    },500);
  }
}

function startLevel2() {
  scene = "level2";
  bg = images["lvl2.png"];
  dogX = 200;
  actionCount = 0;
  if (rainPlaying) { sounds.rain.pause(); rainPlaying = false; }
}

function handleLevel2() {
  if (keys['s']) {
    dogState = "sniff";
    const snd = (Math.random()<0.5)? sounds.sniff1 : sounds.sniff2;
    duckBGM(-0.4, 500);
    snd.play();
    actionCount++;
  }
  if (keys['b']) {
    dogState = "bark";
    duckBGM(-0.4, 500);
    sounds.bark.play();
    actionCount++;
  }
  if (actionCount >= 5 && scene === "level2") {
    duckBGM(-0.6, 1500);
    sounds.knock.play();
    showBubble("Someone's at the door!",2000);
    showTooltip("It's my favourite person! Press H to howl",3000);
    scene = "level2_knock";
  }
}

function handleLevel2Knock() {
  if (keys['h']) {
    dogState = "howl";
    const howlSnd = (Math.random()<0.5)? sounds.howl1 : sounds.howl2;
    duckBGM(-0.8, howlSnd.duration*1000);
    howlSnd.play();
    setTimeout(()=>startFinal(),500);
  }
}

function startFinal() {
  scene = "final";
  stopBGM();
  ctx.drawImage(images["finalscreen.png"],0,0);
  sounds.final.play();
  startFinalTime = Date.now();
}

function handleFinal() {
  let t = (Date.now()-startFinalTime)/1000;
  if (t>=30 && t<48) {
    let fadeAmt = (t-30)/18;
    ctx.fillStyle = `rgba(0,0,0,${fadeAmt})`;
    ctx.fillRect(0,0,canvas.width,canvas.height);
  }
  if (t>=48) {
    ctx.fillStyle = "black";
    ctx.fillRect(0,0,canvas.width,canvas.height);
    endTextEl.style.opacity = 1;
  }
}

/* ---------------------
   MAIN LOOP
--------------------- */
function loop() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if (bg) ctx.drawImage(bg,0,0,1920,1080);
  if (scene==="level1"||scene==="level2"||scene==="level2_knock") {
    // draw dog sprite
    let img;
    if (dogState==="sit") img = images["sit.png"];
    else if (dogState==="walk") img = images["walk1.png"];
    else if (dogState==="sniff") img = images["sniff1.png"];
    else if (dogState==="howl") img = images["howl.png"];
    else if (dogState==="bark") img = images["howl.png"];
    ctx.drawImage(img,dogX,dogY,450,400);
  }
  if (scene==="level1") handleLevel1();
  if (scene==="level2") handleLevel2();
  if (scene==="level2_knock") handleLevel2Knock();
  if (scene==="final") handleFinal();
  requestAnimationFrame(loop);
}

/* ---------------------
   START
--------------------- */
loadImages(imgNames, ()=>{
  // splash
  ctx.drawImage(images["splashscreen.png"],0,0,1920,1080);
  showTooltip("Press SPACE to start");
  window.addEventListener('keydown', e=>{
    if (scene==="splash" && e.code==="Space") {
      playBGM();
      startLevel1();
    }
  });
  loop();
});
</script>
</body>
</html>
